name: Release

on:
  workflow_run:
    workflows: ["Test"]
    types:
      - completed
    branches:
      - 'main'

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Build & Release
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    env:
      BAZEL_BUILD_TARGET_AMD64: //cmd:cmd
      BAZEL_BUILD_TARGET_ARM64: //cmd:cmd_arm64
    steps:
      - name: Calculate previous run number
        id: calc_prev_run
        run: echo "number=$((${{ github.run_number }} - 1))" >> $GITHUB_OUTPUT

      - name: Restore Bazel cache
        uses: actions/cache/restore@v4
        with:
          path: "/home/runner/.cache/bazel"
          key: bazel-release-${{ steps.calc_prev_run.outputs.number }}
          restore-keys: |
            bazel-release-

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Java (required by Bazel)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Bazelisk
        run: |
          sudo curl -L -o /usr/local/bin/bazelisk https://github.com/bazelbuild/bazelisk/releases/download/v1.13.0/bazelisk-linux-amd64
          sudo chmod +x /usr/local/bin/bazelisk
          bazelisk --version

      - name: Build Binaries (AMD64 & ARM64)
        run: |
          mkdir -p release-artifacts
          bazelisk build "$BAZEL_BUILD_TARGET_AMD64"
          cp bazel-bin/cmd/cmd release-artifacts/weft-operator-linux-amd64
          bazelisk build "$BAZEL_BUILD_TARGET_ARM64"
          cp bazel-bin/cmd/cmd_arm64 release-artifacts/weft-operator-linux-arm64
          chmod +x release-artifacts/*

      - name: Sanity Check Binaries
        run: |
          file release-artifacts/weft-operator-linux-amd64 | grep -q "x86-64"
          file release-artifacts/weft-operator-linux-arm64 | grep -q "aarch64"

      - name: Push Multiarch Image
        run: |
          TAG="v1.1.${{ github.run_number }}"
          bazelisk run //cmd:weft_operator_image_push -- --tag "$TAG" --tag latest

      - name: Push Helm chart
        run: |
          bazelisk run //chart:weft_operator.push

      - name: Create Git Tag
        run: |
          TAG="v1.1.${{ github.run_number }}"
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.1.${{ github.run_number }}
          name: Release v1.1.${{ github.run_number }}
          files: release-artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Bazel cache
        uses: actions/cache/save@v4
        with:
          path: "/home/runner/.cache/bazel"
          key: bazel-release-${{ github.run_number }}
